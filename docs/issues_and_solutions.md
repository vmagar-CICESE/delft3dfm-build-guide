# Common Issues and Solutions

This document catalogs the issues encountered while building Delft3D-FM and their solutions.

## Compiler Flag Issues

### Intel vs GNU Fortran Flag Mismatches

**Error:**
gfortran: error: unrecognized command-line option '-qopenmp'; did you mean '-fopenmp'? gfortran: error: unrecognized command-line option '-132'; did you mean '-m32'? gfortran: error: unrecognized command-line option '-recursive'; did you mean '-frecursive'? gfortran: error: unrecognized command-line option '-reentrancy' gfortran: error: unrecognized command-line option '-traceback'

**Cause:** The Delft3D-FM Makefiles use Intel Fortran compiler flags, but we're using GNU Fortran (gfortran).

**Solution:**
```bash
# Replace Intel flags with GNU equivalents in each Makefile
sed -i 's/-qopenmp/-fopenmp/g' Makefile
sed -i 's/-132/-ffixed-line-length-132/g' Makefile
sed -i 's/-recursive/-frecursive/g' Makefile
sed -i 's/-reentrancy threaded//g' Makefile
sed -i 's/-traceback//g' Makefile
```

###  Fortran Argument Mismatches

**Error:** Rank mismatch between actual argument at (1) and actual argument at (2) (scalar and rank-1)

**Cause:** Modern Fortran compilers are stricter about type and rank matching in subroutine calls.

**Solution:** 
```bash
# Add the -fallow-argument-mismatch and -fallow-invalid-boz flags (borrowed from MPAS build approach)
export FFLAGS='-fallow-argument-mismatch -fallow-invalid-boz'
export FCFLAGS='-fallow-argument-mismatch -fallow-invalid-boz'
```


###  Multiple Definition Errors

**Error:** 
/usr/bin/ld: ../src/.libs/f2c.o: multiple definition of `nefis_errno'; ../src/.libs/c2c.o: first defined here
/usr/bin/ld: ../src/.libs/f2c.o: multiple definition of `nefis_flush'; ../src/.libs/c2c.o: first defined here
/usr/bin/ld: ../src/.libs/f2c.o: multiple definition of `error_text'; ../src/.libs/c2c.o: first defined here

**Cause:** 
Variables are defined in multiple header files (c2c.h, f2c.h) and source files (er.c, oc.c).

**Solution:** 
```bash
# Either add extern declarations to header files:
sed -i 's/BInt4   nefis_errcnt;/extern BInt4   nefis_errcnt;/' f2c.h

# Or use the -fcommon flag (simpler approach):
export CFLAGS="-fcommon"
```


### NetCDF Fortran Module Incompatibility

**Error:** 
netcdf_utils.F90(33): error #7013: This module file was not generated by any release of this compiler. [NETCDF]

**Cause:** 
NetCDF Fortran modules need to be built with the same compiler used for the main project.

**Solution:**
```bash
# Build custom NetCDF with Intel Fortran:
FC=mpiifort ./configure --prefix=$HOME/intel-netcdf
make
make install
```

### Path and Environment Issues

**Error:** 
configure: error: "NetCDF not found!"

**Cause:**
Build system can't locate the NetCDF installation.

**Solution:**
```bash
# Set proper environment variables
export NETCDF_HOME=$HOME/intel-netcdf
export LD_LIBRARY_PATH=$NETCDF_HOME/lib:$LD_LIBRARY_PATH
export PATH=$NETCDF_HOME/bin:$PATH
```


### Missing Intel OneAPI Environment

**Error:** 
mpiifort: command not found

**Cause:**
 Intel OneAPI environment not sourced.

**Solution:**
```bash
# Source the Intel OneAPI environment before building
source /opt/intel/oneapi/setvars.sh
```







